<?php
// $Id$

/**
 * @file
 * Integrates with FeedBurner services, primarily feed redirection.
 */

/**
 * Implementation of hook_help().
 */
function feedburner_help($path, $arg) {
  switch ($path) {
    case 'admin/help#feedburner':
      $output .= _feedburner_blurb();
      return $output;
    case 'admin/settings/feedburner':
      $output = '<p>' . t('These are the settings for the FeedBurner module. Once you have everything set, check out your site\'s <a href="@link">FeedBurner feeds</a>.', array('@link' => url('admin/build/feedburner'))) . '</p>';
      return $output;
    case 'admin/build/feedburner':
      $output = '<p>' . t('This is the FeedBurner site feed redirection building page. Make sure to check out the <a href="@link">FeedBurner settings</a>.', array('@link' => url('admin/settings/feedburner'))) . '</p>';
      return $output;
  }
}

/**
 * Implementation of hook_perm().
 */
function feedburner_perm() {
  return array('administer FeedBurner', 'view FeedFlare');
}

/**
 * Implementation of hook_menu().
 */
function feedburner_menu() {
  $items['admin/build/feedburner'] = array(
    'title' => 'FeedBurner',
    'description' => 'Change site feed redirections to FeedBurner.',
    'page callback' => 'feedburner_build_overview',
    'page arguments' => array('site'),
    'access arguments' => array('administer FeedBurner'),
    'file' => 'feedburner.admin.inc',
  );
  $items['admin/build/feedburner/list'] = array(
    'title' => 'Feeds',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );
  foreach (_feedburner_get_feed_categories() as $category => $options) {
    if (!isset($option['module']) || module_exists($options['module'])) {
      $items['admin/build/feedburner/list/' . $category] = array(
        'title' => drupal_ucfirst($category),
        'type' => isset($options['default']) ? MENU_DEFAULT_LOCAL_TASK : MENU_LOCAL_TASK,
        'weight' => isset($options['default']) ? -10 : 0,
        'page callback' => 'feedburner_build_overview',
        'page arguments' => array($category),
        'access arguments' => array('administer FeedBurner'),
        'file' => 'feedburner.admin.inc',
      );
    }
  }
  $items['admin/build/feedburner/burn'] = array(
    'title' => 'Burn feed',
    'type' => MENU_LOCAL_TASK,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('feedburner_burn_form'),
    'access arguments' => array('administer FeedBurner'),
    'file' => 'feedburner.admin.inc',
  );
  $items['admin/build/feedburner/unburn'] = array(
    'title' => 'Unburn feed',
    'type' => MENU_CALLBACK,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('feedburner_unburn_form'),
    'access arguments' => array('administer FeedBurner'),
    'file' => 'feedburner.admin.inc',
  );
  $items['admin/settings/feedburner'] = array(
    'title' => 'FeedBurner',
    'description' => 'Administer FeedBurner integration.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('feedburner_settings_form'),
    'access arguments' => array('administer FeedBurner'),
    'file' => 'feedburner.admin.inc',
  );
  $items['admin/feedburner/autocomplete'] = array(
    'page callback' => 'feedburner_autocomplete',
    'type' => MENU_CALLBACK,
    'access arguments' => array('administer FeedBurner'),
    'file' => 'feedburner.admin.inc',
  );
  $items['feedburner/feedflare'] = array(
    'page callback' => 'feedburner_feedflare',
    'type' => MENU_CALLBACK,
    'access callback' => TRUE,
  );
  return $items;
}

/**
 * Implementation of hook_boot().
 */
function feedburner_boot() {
  drupal_bootstrap(DRUPAL_BOOTSTRAP_PATH);
  $path = _feedburner_get_path();
  _feedburner_check_redirect($path);
}

/**
 * Implementation of hook_nodeapi().
 *
 * Inserts FeedFlare into nodes.
 */
function feedburner_nodeapi(&$node, $op, $teaser = NULL, $page = NULL) {
  if ($op == 'view' && $node->build_mode != NODE_BUILD_PREVIEW && user_access('view FeedFlare')) {
    $display = $teaser ? 'teaser' : ($page ? 'page' : NULL);
    $feedflare_display = variable_get('feedburner_feedflare_display', array('page'));
    if (in_array($display, $feedflare_display) && $feedflare = _feedburner_get_feedflare($node->nid, $node->type)) {
      $node->content['feedflare'] = array(
        '#value' => $feedflare,
        '#weight' => 10,
      );
    }
  }
}

/**
 * Implementation of hook_user().
 *
 * Displays, validates and saves an option to redirect a user's blog feed.
 */
function feedburner_user($op, &$edit, &$account, $category = NULL) {
  if ($op == 'form' && $category == 'account' && user_access('create blog entries') && variable_get('feedburner_blogs', 0)) {
    $user_blog_url = 'blog/' . $account->uid . '/feed';
    $form['feedburner'] = array(
      '#type' => 'fieldset',
      '#title' => t('Your Blog\'s FeedBurner Settings'),
      '#weight' => 1,
      '#collapsible' => TRUE,
      '#description' => t('Requests for your blog\'s feed (<a href="@url">@url</a>) will be redirected to the FeedBurner feed below. Leave this blank to disable redirection.', array('@url' => url($user_blog_url, array('absolute' => TRUE)))),
    );
    $form['feedburner']['feedburner_user_blog'] = array(
      '#type' => 'textfield',
      '#maxlength' => 100,
      '#size' => 30,
      '#default_value' => db_result(db_query("SELECT feedburner FROM {feedburner} WHERE path = '%s'", $user_blog_url)),
      '#field_prefix' => _feedburner_construct_url(),
      '#description' => t('This field is case-sensitive and alphanumeric.'),
    );
    return $form;
  }
  elseif ($op == 'validate' && isset($edit['feedburner_user_blog'])) {
    // TODO: Matches slashes??
    if (preg_match('%[^\w-/]%', $edit['feedburner_user_blog'])) {
      form_set_error('feedburner_user_blog', 'Invalid FeedBurner feed name');
    }
  }
  elseif ($op == 'update' && isset($edit['feedburner_user_blog'])) {
    module_load_include('inc', 'feedburner', 'feedburner.admin');
    $user_blog_url = 'blog/' . $account->uid . '/feed';
    _feedburner_save_feed($user_blog_url, $edit['feedburner_user_blog']);
    $edit['feedburner_user_blog'] = NULL;
  }
  elseif ($op == 'delete') {
    module_load_include('inc', 'feedburner', 'feedburner.admin');
    $user_blog_url = 'blog/' . $account->uid . '/feed';
    _feedburner_save_feed($user_blog_url);
  }
}

/**
 * Implementation of hook_block().
 */
function feedburner_block($op = 'list', $delta = 0, $edit = array()) {
  if ($op == 'list') {
    $blocks[0]['info'] = t('FeedBurner FeedFlare');
    $blocks[0]['cache'] = BLOCK_CACHE_PER_ROLE | BLOCK_CACHE_PER_PAGE;
    $blocks[1]['info'] = t('FeedBurner E-mail Subscribe');
    $blocks[1]['cache'] = BLOCK_CACHE_PER_PAGE;
    $blocks[2]['info'] = t('FeedBurner FeedCount');
    $blocks[2]['cache'] = BLOCK_CACHE_GLOBAL;
    $blocks[3]['info'] = t('FeedBurner Feeds');
    $blocks[3]['cache'] = BLOCK_CACHE_GLOBAL;
    return $blocks;
  }
  elseif ($op == 'configure' && $delta == 1) {
    module_load_include('inc', 'feedburner', 'feedburner.admin');
    $feeds = array(0 => 'None (disabled)');
    $result = db_query('SELECT DISTINCT feedburner FROM {feedburner} ORDER BY feedburner');
    while ($feed = db_result($result)) {
      $details = _feedburner_get_feed_features($feed);
      if ($details->id) {
        $feeds[$details->id] = $feed;
      }
    }
    $form['feedburner_block_email_id'] = array(
      '#type' => 'select',
      '#title' => t('FeedBurner feed'),
      '#default_value' => variable_get('feedburner_block_email_id', 0),
      '#options' => $feeds,
      '#description' => t('Only feeds with the email subscription feature verified can be selected.'),
    );
    return $form;
  }
  elseif ($op == 'configure' & $delta == 2) {
    $feeds = array(0 => 'None (disabled)');
    $result = db_query('SELECT DISTINCT feedburner FROM {feedburner} ORDER BY feedburner');
    while ($feed = db_result($result)) {
      $feeds[$feed] = $feed;
    }
    $form['feedburner_block_feedcount_feed'] = array(
      '#type' => 'select',
      '#title' => t('FeedBurner feed'),
      '#default_value' => variable_get('feedburner_block_feedcount_feed', 0),
      '#options' => $feeds,
    );
    return $form;
  }
  elseif ($op == 'save' && $delta == 1) {
    variable_set('feedburner_block_email_id', (int) $edit['feedburner_block_email_id']);
  }
  elseif ($op == 'save' && $delta == 2) {
    variable_set('feedburner_block_feedcount_feed', $edit['feedburner_block_feedcount_feed']);
  }
  elseif ($op == 'view') {
    $block = array();
    switch ($delta) {
      case 0:
        if (arg(0) == 'node' && is_numeric(arg(1)) && arg(2) == NULL) {
          $node = node_load(arg(1));
          if ($feedflare = _feedburner_get_feedflare($node->nid, $node->type)) {
            $block['subject'] = t('FeedFlare');
            $block['content'] = $feedflare;
          }
        }
        return $block;
      case 1:
        $id = variable_get('feedburner_block_email_id', 0);
        if ($id) {
          // TODO: Convert to Form API? or better containing divs?
          $block['subject'] = t('Get E-mail Updates');
          $block['content'] .= '<form action="http://www.feedburner.com/fb/a/emailverify" method="post" target="popupwindow" onsubmit="window.open(\'http://www.feedburner.com\', \'popupwindow\', \'scrollbars=yes,width=550,height=520\');return true;" id="feedburner-block-email-form"><div class="container-inline" id="feedburner-block-email">';
          $block['content'] .= '<div class="form-item">';
          $block['content'] .= '<label for="feedburner-block-email-form-email">Enter your email address:</label>';
          $block['content'] .= '<input type="text" size="15" name="email" id="feedburner-block-email-form-email" />';
          $block['content'] .= '</div>';
          $block['content'] .= '<input type="hidden" value="http://feeds.feedburner.com/~e?ffid=' . $id . '" name="url"/>';
          $block['content'] .= '<input type="submit" value="Subscribe" class="form-submit" />';
          $block['content'] .= '<p>Delivered by <a href="http://www.feedburner.com">FeedBurner</a></p>';
          $block['content'] .= '</div></form>';
        }
        return $block;
      case 2:
        $feed = variable_get('feedburner_block_feedcount_feed', 0);
        if (!empty($feed)) {
          $block['content'] = '<a href="http://feeds.feedburner.com/' . $feed . '"><img src="http://feeds.feedburner.com/~fc/' . $feed . '?bg=99CCFF&amp;fg=444444&amp;anim=0" height="26" width="88" style="border:0" alt="" /></a>';
        }
        return $block;
      case 3:
        module_load_include('inc', 'feedburner', 'feedburner.admin');
        $block['subject'] = variable_get('site_name', 'Drupal') . t(' Feeds');
        $feeds = db_query("SELECT path, feedburner FROM {feedburner}");
        //$block['content'] .= '<ul style="list-style-image: url(\'../../misc/feed.png\') !important;">';
        $block['content'] = '<ul>';
        while ($feed = db_fetch_object($feeds)) {
          $features = _feedburner_get_feed_features($feed->feedburner);
          $block['content'] .= '<li>' . theme('image', 'misc/feed.png') . ' <a href="' . _feedburner_construct_url($feed->feedburner) . '">' . ($features->title ? $features->title : $feed->path) .'</a></li>';
        }
        $block['content'] .= '</ul>';
        return $block;
    }
  }
}

/**
 * Check to see if the current path has a FeedBurner feed redirect, and perform
 * the redirection as necessary.
 *
 * @param $path
 *   The current request path.
 */
function _feedburner_check_redirect($path) {
  // Don't waste time and database hits on certain paths (admin paths, frontpage)
  if (drupal_is_front_page() || preg_match('/^admin\//i', $path)) {
    return;
  }

  $skip_redirect = (isset($_GET['redirect']) && $_GET['redirect'] == 'no');
  $useragents_regex = variable_get('feedburner_useragents', '/feedburner|feedvalidator/i');

  if (!$skip_redirect
      && !preg_match($useragents_regex, $_SERVER['HTTP_USER_AGENT'])
      && $feedburner = db_result(db_query("SELECT feedburner FROM {feedburner} WHERE path = '%s'", $path))) {
    $url = _feedburner_construct_url($feedburner);
    $status = variable_get('feedburner_redirect_status', 307);

    // Need to make a condensed copy of drupal_goto since common.inc is not yet
    // loaded (it will be if we hit DRUPAL_BOOTSTRAP_FULL). We can skip lots of
    // unneeded includes and processing since we are now going to redirect the
    // user and not continue any more Drupal loading.
    module_invoke_all('exit', $url);
    session_write_close();
    header('Location: ' . $url, TRUE, (int) $status);
    exit();
  }
}

/**
 * Constructs an absolute url based on a FeedBurner feed URI.
 *
 * @param $uri
 *   The FeedBurner feed URI.
 * @return
 *   The full URL of the FeedBurner feed.
 */
function _feedburner_construct_url($uri = '') {
  return 'http://' . variable_get('feedburner_domain', 'feeds.feedburner.com') . '/' . $uri;
}

/**
 * Determines if we can use the FeedBurner API.
 */
function _feedburner_can_api($valid_account = FALSE) {
  return !variable_get('drupal_http_request_fails', FALSE) && extension_loaded('SimpleXML') && function_exists('simplexml_load_string') && (!$valid_account || variable_get('feedburner_auth', FALSE));
}

/*
 * Extract part of the current Drupal path from a certain 'argument' onward.
 *
 * For example, if the path is 'http://example-drupal/blah/foo/foobar/ferzle':
 *   $pos = 0, returns 'blah/foo/foobar/ferzle'
 *   $pos = 2, returns 'foobar/ferzle'
 *   $pos = 4, returns ''
 *
 * @param $pos
 *   The argument of the path to start at, use 0 to get the whole path
 * @return
 *   The extracted part of the path
 */
function _feedburner_get_path($pos = 0) {
  $path = str_replace(' ', '+', $_GET['q']);
  if ($pos > 0) {
    $path = explode('/', $path, $pos);
    $path = (count($path) >= $pos ? end($path) : '');
  }
  return $path;
}

/**
 * Returns a list of feed categories.
 */
function _feedburner_get_feed_categories() {
  return array(
    'site' => array('default' => TRUE),
    'blogs' => array('module' => 'blog'),
    'taxonomy' => array('module' => 'taxonomy'),
  );
}

/**
 * Gets the script for feedflare based on node id and node type.
 *
 * @param $nid
 *   The node id.
 * @param $node_types
 *   The node's type (story, blog, etc.).
 * @return
 *   A JavaScript code for FeedFlare.
 */
function _feedburner_get_feedflare($nid, $node_type) {
  $feedflare_feed = variable_get('feedburner_feedflare_feed', 0);
  $feedflare_node_types = variable_get('feedburner_feedflare_node_types', array());
  if ($feedflare_feed && in_array($node_type, $feedflare_node_types)) {
    return '<script src="http://feeds.feedburner.com/~s/' . $feedflare_feed . '?i=' . url('node/' . $nid, array('absolute' => TRUE)) . '" type="text/javascript" charset="utf-8"></script>';
  }
  return FALSE;
}

/**
 * Bleh.
 */
function _feedburner_blurb() {
  return '<p style="text-align: center; font-size: smaller;">' . t('This module was developed by <a href="@link-dave">Dave Reid</a> with assistance from <a href="@link-feedburner">FeedBurner</a>.<br />Please consider <a href="@link-review">reviewing this module on drupalmodules.com</a> or <a href="@link-donate">donating to the developer\'s replacement laptop fund</a>.', array('@link-dave' => 'http://davereid.net/', '@link-feedburner' => 'http://www.feedburner.com/', '@link-review' => 'http://drupalmodules.com/module/feedburner', '@link-donate' => 'http://davereid.net/content/laptop-fund')) . '</p>';
}

function feedburner_feedflare($feedflare) {
  header('Content-type: application/xml');
  echo '<!DOCTYPE FeedFlareUnit SYSTEM "FeedFlareUnit-1.0.dtd">';
  switch ($feedflare) {
    case 'comments':
      if (isset($_GET['nid']) && is_numeric($_GET['nid'])) {
        $node = node_load($_GET['nid']);
        if ($node->comment != COMMENT_NODE_DISABLED) {
          echo '<FeedFlare>
  <Text>' . format_plural($node->comment_count, '@count comment', '@count comments') . '</Text>
  <Link href="'. url('node/'. $node->nid, array('fragment' => 'comments', 'absolute' => TRUE)) .'"/>
</FeedFlare>';

        }
      }
      else {
        echo '<FeedFlareUnit>
  <Catalog>
    <Title>Drupal comment count</Title>
    <Description>Returns the number of comments for a Drupal node</Description>
  </Catalog>
  <DynamicFlare href="' . url('feedburner/feedflare/comments', array('absolute' => TRUE, 'query' => 'nid=${fn:substring-before(a:id, \' \')}')) . '" />
</FeedFlareUnit>';
      }

  }
  exit();
}
